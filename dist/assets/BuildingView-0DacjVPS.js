import{r as u,j as m,u as b,n as r,k as g,c as d,m as x,p as _,l as i,v as k,t as $,o as p}from"./vue-CluIPJnQ.js";import{a as S}from"./axios-xsH4HHeE.js";import{_ as z}from"./index-EZjxmscV.js";import{u as L,i as A,g as B,h as C,b as O,c as V,e as E,d as N}from"./echarts-BqiCTMEy.js";const W={class:"energy-consumption-container"},D={key:0,class:"loading-overlay"},H={class:"chart-wrapper"},M={class:"building-title"},R={__name:"BuildingView",setup(T){L([B,C,O,V,E,N]);const h=b(),t=u(null),l=u({weekly:[]}),n=u(!0);let a=null,o=null;const v=async()=>{try{if(!t.value)throw new Error("图表容器未创建");t.value.style.display="block",t.value.style.visibility="visible",await r();const{offsetWidth:e,offsetHeight:s}=t.value;(e===0||s===0)&&(console.warn("容器尺寸异常，使用强制尺寸"),t.value.style.width="800px",t.value.style.height="600px",await r()),a&&a.dispose(),a=A(t.value,null,{renderer:"svg",width:"auto",height:"auto"});const c=w();a.setOption(c),o=new ResizeObserver(()=>{a==null||a.resize()}),o.observe(t.value),a.resize()}catch(e){console.error("图表初始化失败:",e),y(e.message)}},w=()=>{if(!l.value.weekly||!Array.isArray(l.value.weekly))throw new Error("无效的数据结构");return{title:{text:"七日能耗趋势分析",left:"center",textStyle:{fontSize:18,color:"#2c3e50"}},tooltip:{trigger:"axis",formatter:e=>`
        <b>${e[0].axisValue}</b><br>
        <span style="color:${e[0].color}">●</span> ${e[0].seriesName}: ${e[0].data}kWh<br>
        <span style="color:${e[1].color}">●</span> ${e[1].seriesName}: ${e[1].data}吨
      `},legend:{data:["电力消耗","水资源消耗"],top:35,itemGap:20},grid:{left:"3%",right:"4%",bottom:"12%",containLabel:!0},xAxis:{type:"category",data:l.value.weekly.map(e=>(e.day||console.warn("缺少日期字段:",e),e.day)),axisLabel:{rotate:45,formatter:e=>{try{const[s,c,f]=e.split("-");return`${c}/${f}`}catch{return e}}}},yAxis:[{type:"value",name:"电力消耗 (kWh)",axisLine:{lineStyle:{color:"#5470c6"}},splitLine:{show:!1}},{type:"value",name:"水资源消耗 (吨)",axisLine:{lineStyle:{color:"#91cc75"}},position:"right",splitLine:{show:!1}}],series:[{name:"电力消耗",type:"line",data:l.value.weekly.map(e=>(typeof e.electricity!="number"&&console.warn("无效的电力数据:",e),e.electricity)),smooth:!0,itemStyle:{color:"#5470c6"},lineStyle:{width:3},symbol:"circle",symbolSize:8},{name:"水资源消耗",type:"line",yAxisIndex:1,data:l.value.weekly.map(e=>(typeof e.water!="number"&&console.warn("无效的水资源数据:",e),e.water)),smooth:!0,itemStyle:{color:"#91cc75"},lineStyle:{width:3},symbol:"circle",symbolSize:8}]}},y=e=>{t.value&&(t.value.innerHTML=`
      <div class="error-overlay">
        <h3>图表加载失败</h3>
        <p>${e}</p>
        <button onclick="location.reload()">刷新页面</button>
      </div>
    `)};return m(async()=>{try{const e=await S.get(`http://localhost:3000/buildings/${h.params.id}`);l.value=e.data,await r(),await r(),await v()}catch(e){console.error("主流程初始化失败:",e),y(e.message)}finally{n.value=!1}}),g(()=>{a&&(a.dispose(),a=null),o&&(o.disconnect(),o=null)}),(e,s)=>(p(),d("div",W,[n.value?(p(),d("div",D,s[0]||(s[0]=[i("div",{class:"loader"},null,-1),i("p",null,"数据加载中...",-1)]))):x("",!0),_(i("div",H,[i("h2",M,$(l.value.name)+" 能耗趋势",1),i("div",{ref_key:"chartContainer",ref:t,class:"chart-container",style:{width:"100%","min-width":"800px",height:"600px",display:"block"}},null,512)],512),[[k,!n.value]])]))}},q=z(R,[["__scopeId","data-v-0bc889e8"]]);export{q as default};
